const clone = require('clone')

let db = {}

const defaultData = {
  "8xf0y6ziyjabvozdd253nd": {
    id: '8xf0y6ziyjabvozdd253nd',
    timestamp: 1467166872634,
    title: 'Why political correctness is bad',
    body: `Mom was wrong when she taught me, “Sticks and stones may break my bones, but names will never hurt me.” Names do hurt — names can shame, ridicule, and humiliate. Some pertain to race or gender; others refer to weight, facial features, or a particular part of one’s anatomy. Names that refer to social class or what part of the country you’re from can be hurtful, as can names that involve age, religion, or physical ability. Even slang names for certain occupations can be hurtful. Certainly, no one likes to be called a name that is disrespectful, unkind, or downright mean.

But there is another category of name-calling that is also hurtful and destructive: names such as “racist,” “sexist,” “homophobe,” “anti-Semite,” “bigot,” and the like. Yet many throw these labels around at the drop of a hat, without understanding what the labels actually mean — not to mention the damage done by accusing someone of racism, sexism, etc. The accusation alone — even without merit — can be enough to besmirch a reputation, kill a career, and/or be used to invalidate a lifetime of good work.

Let’s consider the definition of racism: “a belief that race is the primary determinant of human traits and capacities and that racial difference produce an inherent superiority of a particular race.” How about the definition of sexism: “prejudice or discrimination based on sex; especially: discrimination against women.” And let’s see who is a bigot: “a person who is obstinately or intolerantly devoted to his or her own opinions and prejudices; especially: one who regards or treats the members of a group (as a racial or ethnic group) with hatred and intolerance.”

I wonder, do the TV talking heads understand the true definition of the labels they hurl at public figures: “racist,” “sexist,” “bigoted,” or worse — based on nothing more than a comment taken out of context, someone’s clumsy attempt at humor, or a photo or image that’s the artistic expression of a creative person?

How many of us understand these definitions when we call someone a racist or sexist jerk? Jerk, perhaps... but racist or sexist? Perhaps... perhaps not. Do we really understand the seriousness of those labels? Or, are we simply indulging in destructive name-calling based on political correctness?

My point is that the political correctness movement has gone way too far. While the original intent of political correctness may have been good (to encourage tact and sensitivity to others’ feelings around issues of gender, race, religion, sexual orientation, physical abilities, and such), the effect of political correctness has been to make everyone avoid these topics altogether — thereby hindering our ability to get comfortable in living and working with those who are different from us. It’s gone so far that political correctness has become a bigger problem than the problem it was intended to address!

It’s gotten so bad that a liberal professor friend of mine says that she thinks the whole political correctness movement was invented by the Far Right to inhibit any meaningful discussion of diversity issues in order to keep racial, gender, and other barriers in place. Wow. Could my cynical (dare I say paranoid) friend be right?

It doesn’t really matter whether the PC Police come from the Right or the Left; the result is the same. These days everyone is so afraid of being called “sexist” or “racist” or “anti-Semitic” or some other career-killing label, that we all tiptoe carefully around diversity issues, and avoid them altogether if we possibly can.

But the question is: How are we ever going to be able to live and work together more comfortably if there’s a whole herd of elephants in the room? If we can’t talk about our feelings, fears, aspirations, anxieties, assumptions, hopes, worries, dreams, and concerns, how can we ever build trust with those who are different from us? If we can’t talk about differences that puzzle us, or things we’re curious about, without fear of giving offense, then how can we ever overcome our ignorance about cultures and races — or even the opposite sex?

If we must constantly self-censor any conversation pertaining to race, gender, religion, sexual orientation, or physical ability, then we are doomed to perpetuate the very barriers we say we want to overcome.

To those who serve in today’s PC Police, I understand that your intentions are good. But there is often a big gap between intent and impact. I would invite you to consider the impact of your censorship and finger-wagging, as well as your inclination to self-righteous, moral indignation. You don’t realize it, but you’re effectively throwing a wet blanket over public (and private) discussions of vitally important issues. You’ve gone too far in your efforts to protect everyone’s feelings. You’re essentially imposing a gag order on the whole of American society, and in so doing, you’re hindering our progress in getting to know one another and to understand others’ different perspectives, viewpoints, feelings, and life experiences.`,
    author: 'BJ Gallagher',
    category: 'Controversy',
    voteScore: 149302,
    deleted: false,
    commentCount: 4
  },
  "6ni6ok3ym7mf1p33lnez": {
    id: '6ni6ok3ym7mf1p33lnez',
    timestamp: 1468479767190,
    title: `Hillary Clinton's Shocking Rant: This Is How Much She Despises Americans in the Heartland`,
    body: `During her recent trip to India, Hillary Clinton told an Indian audience in Mumbai the reasons she lost the 2016 election. She said that Donald Trump's voters "hated black people getting rights and women getting jobs."  She claimed that she won the successful parts of the country and that Trump won the "backwards" areas.

"I won the places that represent two-thirds of America's gross domestic product," Clinton said. "So I won the places that are optimistic, diverse, dynamic, moving forward. And his whole campaign, 'Make America Great Again,' was looking backwards."\n Conservative commentator Erick Erickson wrote on his website, The Resurgent, despite Clinton's claims that Trump or his voters wouldn't want Indian-Americans succeeding, it was Trump who appointed Nikki Haley, an India-American as UN Ambassador, and it was Republican voters in South Carolina and Louisiana who elected Indian-Americans Nikki Haley and Bobby Jindal as governors respectively.

Erickson also wrote, "Well, she was finally willing to admit it. Speaking out of the country in India, Hillary Clinton let loose with a diatribe against the American Heartland."

He also said, "Her remarks dripped with contempt for Americans."

Since Clinton's loss in 2016, a number of Democrats have called for their party to move on from the election and focus on the future.

NOTE: This story has been updated. Earlier references to statements by Patty Solis Doyle and Rep. Joe Crowley were incorrect in their context.`,
    author: 'Donald Trump',
    category: 'Politics',
    voteScore: 9147,
    deleted: false,
    commentCount: 2
  },
  "6ni6ok3ymchingnez": {
    id: '6ni6ok3ymchingnez',
    timestamp: 1468479767190,
    title: 'Why smoking weed could be good for you',
    body:`There are few subjects that can stir up stronger emotions among doctors, scientists, researchers, policy makers, and the public than medical marijuana. Is it safe? Should it be legal? Decriminalized? Has its effectiveness been proven? What conditions is it useful for? Is it addictive? How do we keep it out of the hands of teenagers? Is it really the \u201Cwonder drug\u201D that people claim it is? Is medical marijuana just a ploy to legalize marijuana in general?\r\n\r\nThese are just a few of the excellent questions around this subject, questions that I am going to studiously avoid so we can focus on two specific areas: why do patients find it useful, and how can they discuss it with their doctor?\r\n\r\nMarijuana is currently legal, on the state level, in 29 states, and in Washington, DC. It is still illegal from the federal government\u2019s perspective. The Obama administration did not make prosecuting medical marijuana even a minor priority. President Donald Trump promised not to interfere with people who use medical marijuana, though his administration is currently threatening to reverse this policy. About 85% of Americans support legalizing medical marijuana, and it is estimated that at least several million Americans currently use it.\r\n\r\nMarijuana without the high\r\nLeast controversial is the extract from the hemp plant known as CBD (which stands for cannabidiol) because this component of marijuana has little, if any, intoxicating properties. Marijuana itself has more than 100 active components. THC (which stands for tetrahydrocannabinol) is the chemical that causes the \u201Chigh\u201D that goes along with marijuana consumption. CBD-dominant strains have little or no THC, so patients report very little if any alteration in consciousness.\r\n\r\nPatients do, however, report many benefits of CBD, from relieving insomnia, anxiety, spasticity, and pain to treating potentially life-threatening conditions such as epilepsy. One particular form of childhood epilepsy called Dravet syndrome is almost impossible to control, but responds dramatically to a CBD-dominant strain of marijuana called Charlotte\u2019s Web. The videos of this are dramatic.\r\n\r\nUses of medical marijuana\r\nThe most common use for medical marijuana in the United States is for pain control. While marijuana isn\u2019t strong enough for severe pain (for example, post-surgical pain or a broken bone), it is quite effective for the chronic pain that plagues millions of Americans, especially as they age. Part of its allure is that it is clearly safer than opiates (it is impossible to overdose on and far less addictive) and it can take the place of NSAIDs such as Advil or Aleve, if people can\u2019t take them due to problems with their kidneys or ulcers or GERD.\r\n\r\nIn particular, marijuana appears to ease the pain of multiple sclerosis, and nerve pain in general. This is an area where few other options exist, and those that do, such as Neurontin, Lyrica, or opiates are highly sedating. Patients claim that marijuana allows them to resume their previous activities without feeling completely out of it and disengaged.\r\n\r\nAlong these lines, marijuana is said to be a fantastic muscle relaxant, and people swear by its ability to lessen tremors in Parkinson\u2019s disease. I have also heard of its use quite successfully for fibromyalgia, endometriosis, interstitial cystitis, and most other conditions where the final common pathway is chronic pain.\r\n\r\nMarijuana is also used to manage nausea and weight loss, and can be used to treat glaucoma. A highly promising area of research is its use for PTSD in veterans who are returning from combat zones. Many veterans and their therapists report drastic improvement and clamor for more studies, and for a loosening of governmental restrictions on its study. Medical marijuana is also reported to help patients suffering from pain and wasting syndrome associated with HIV, as well as irritable bowel syndrome and Crohn\u2019s disease.\r\n\r\nThis is not intended to be an inclusive list, but rather to give a brief survey of the types of conditions for which medical marijuana can provide relief. As with all remedies, claims of effectiveness should be critically evaluated and treated with caution.\r\n\r\nTalking with your doctor\r\nMany patients find themselves in the situation of wanting to learn more about medical marijuana, but feel embarrassed to bring this up with their doctor. This is in part because the medical community has been, as a whole, overly dismissive of this issue. Doctors are now playing catch-up, and trying to keep ahead of their patients\u2019 knowledge on this issue. Other patients are already using medical marijuana, but don\u2019t know how to tell their doctors about this for fear of being chided or criticized.\r\n\r\nMy advice for patients is to be entirely open and honest with your physicians and to have high expectations of them. Tell them that you consider this to be part of your care and that you expect them to be educated about it, and to be able to at least point you in the direction of the information you need.\r\n\r\nMy advice for doctors is that whether you are pro, neutral, or against medical marijuana, patients are embracing it, and although we don\u2019t have rigorous studies and \u201Cgold standard\u201D proof of the benefits and risks of medical marijuana, we need to learn about it, be open-minded, and above all, be non-judgmental. Otherwise, our patients will seek out other, less reliable sources of information; they will continue to use it, they just won\u2019t tell us, and there will be that much less trust and strength in our doctor-patient relationship. I often hear complaints from other doctors that there isn\u2019t adequate evidence to recommend medical marijuana, but there is even less scientific evidence for sticking our heads in the sand.`,
    author: '420whatyesmokin',
    category: 'Controversy',
    voteScore: 914710813,
    deleted: false,
    commentCount: 0
  },


  "8xf0y6ziyjabvozdd253nd": {
    id: '8xf0y6ziyjabvozdd253nd',
    timestamp: 1467166872634,
    title: 'Why political correctness is bad',
    body : '',
    author: 'Donald Trump',
    category: 'Politics',
    voteScore: 9147,
    deleted: false,
    commentCount: 2
  },
}

function getData (token) {
  let data = db[token]
  if (data == null) {
    data = db[token] = clone(defaultData)
  }
  return data
}

function getByCategory (token, category) {
  return new Promise((res) => {
    let posts = getData(token)
    let keys = Object.keys(posts)
    let filtered_keys = keys.filter(key => posts[key].category === category && !posts[key].deleted)
    res(filtered_keys.map(key => posts[key]))
  })
}

function get (token, id) {
  return new Promise((res) => {
    const posts = getData(token)
    res(
      posts[id].deleted
        ? {}
        : posts[id]
    )
  })
}

function getAll (token) {
  return new Promise((res) => {
    const posts = getData(token)
    let keys = Object.keys(posts)
    let filtered_keys = keys.filter(key => !posts[key].deleted)
    res(filtered_keys.map(key => posts[key]))
  })
}

function add (token, post) {
  return new Promise((res) => {
    let posts = getData(token)

    posts[post.id] = {
      id: post.id,
      timestamp: post.timestamp,
      title: post.title,
      body: post.body,
      author: post.author,
      category: post.category,
      voteScore: 1,
      deleted: false,
      commentCount: 0
    }

    res(posts[post.id])
  })
}

function vote (token, id, option) {
  return new Promise((res) => {
    let posts = getData(token)
    post = posts[id]
    switch(option) {
        case "upVote":
            post.voteScore = post.voteScore + 1
            break
        case "downVote":
            post.voteScore = post.voteScore - 1
            break
        default:
            console.log(`posts.vote received incorrect parameter: ${option}`)
    }
    res(post)
  })
}

function disable (token, id) {
    return new Promise((res) => {
      let posts = getData(token)
      posts[id].deleted = true
      res(posts[id])
    })
}

function edit (token, id, post) {
    return new Promise((res) => {
        let posts = getData(token)
        for (prop in post) {
            posts[id][prop] = post[prop]
        }
        res(posts[id])
    })
}

function incrementCommentCounter(token, id, count) {
  const data = getData(token)
  if (data[id]) {
    data[id].commentCount += count
  }
}

module.exports = {
  get,
  getAll,
  getByCategory,
  add,
  vote,
  disable,
  edit,
  getAll,
  incrementCommentCounter
}
